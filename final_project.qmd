---
title: "Final Project: Data Science Culmination Project"
format: pdf
---

\noindent Project Proposal: Week of November 18th-22nd

\noindent Project Due: Our Final Exam Time.

```{r}
#| label: install packages

# install.packages("rvest")
# install.packages("tidymodels")
# install.packages("rpart")
# install.packages("rpart.plot")
# install.packages("MASS")
library("rvest")
library("tidyverse")
library("tidymodels")
library("rpart")
library("rpart.plot")
library("MASS")
library("class")
```


## Assignment Description

This is it! This is the culmination of all your work in both of the data science courses! The parameters of this project are very general because I want to give you the chance to explore your interests and be creative. Generally, your project will go through the entire data science process. The project will involve a formal written document as well as a presentation. The written document will be worth 2/3rd's of the final grade and the presentation will be worth the other 1/3rd. 


Here are the sections on how the project will be evaluated (A rubric will be released later with more specific parameters).

* Questions and Goals: The questions you wish to answer and the goals of the project. You should have multiple questions that you answer in the project. Not all of them need to be questions that require modeling to answer, but some of them need to be.
* Data Acquisition: The project describes how the data was obtained and gives substantial backround on the data. 
* Data Preprocessing: Throughout the project, the proper preprocessing techniques (variable transformations, reshaping data, etc.) are utilized.
* Exploratory Data Analysis: Proper exploratory plots and summarizes are utilized to describe the data and showcase certain interesting aspects of the data that you will explore later in the project.
* Modeling and Analysis: This is a large portion of the project! You work toward answer the questions/goals you stated at the beginning. Your project needs to include at least 3 modeling techniques we discussed in class. You will fit, tune, and compare the methods. You will discuss the results and why they make sense in context. This section can include a wide range of modeling techniques. Your proposal should be focused on describing what you want to do in this section.
* Data Product: You present your data, models, and conclusions in a professional manner. This could include an interactive data product.



## Place Work Below!!

# The Dataset

We're using the "Collections" dataset from the Museum of Modern Art (MoMA), which actually comes as 2 separate datasets: "Artists" and "Artworks". The observations in Artworks include both the artist's name and their constituentID, which are both variables in the Artists dataset. So, we're gonna start by just merging the two together. The data types between the two sets are different, so we also have to do some wrangling first.

Many of the artists have missing nationality and/or biography information, despite the information being readily available; this is presumably just because the information wasn't included in the MoMA page. To counter this, we (are trying to) scrape information about different artists to reference with our missing nationalities.
```{r}
#| label: load & tidy data

# shared variables: ConstituentID, DisplayName (Artist), ArtistBio, Nationality, Gender,
# BeginDate, EndDate, 

Artworks <- read_csv("Artworks.zip")
Artists <- read_csv("Artists.zip")

artists <- Artists %>% 
  mutate(ConstituentID = as.character(ConstituentID))

artworks <- full_join(artists, Artworks, by = join_by(ConstituentID, DisplayName == Artist)) %>% 
  mutate(Date = as.integer(str_extract(Date, "\\d{4}"))) %>% 
  rename(cirumference = "Circumference (cm)",
         depth = "Depth (cm)",
         diameter = "Diameter (cm)",
         height = "Height (cm)",
         length = "Length (cm)",
         width = "Width (cm)",
         seat_height = "Seat Height (cm)",
         duration = "Duration (sec.)")

Artists %>% 
  filter(is.na(Nationality))

Artworks %>% 
  filter(ConstituentID == 2)
```

# EDA

As part of our EDA and data tidying, we need to consider which wars were going on when each piece was created. To start, just reference the oldest and most recent pieces:
```{r}
#| label: oldest work

Artworks %>% 
  drop_na(Date) %>% 
  mutate(Date = str_extract(Date, "\\d{4}")) %>% 
  arrange(Date)
```

Our next problem is tidying these new datasets (and perhaps combining them down into one). The biggest problem is the "belligerents" column(s); there's all sorts of formatting within the column, and countries might not be listed under the same names as our other datasets. Let's look at our nationalities to see:

```{r}
#| label: count nationalities

Artists %>% 
  group_by(Nationality) %>% 
  count()

Artists %>% 
  filter(Nationality == "Caribbean")
```

Now comes the unfortunate part. Our *artists* have nationalities (e.g., "French"), but our *wars* have countries (e.g., "France"). I don't think there's any good way to automate this, unfortunately; we just have to suck it up and make a big list of countries & nationality names:
```{r}
#| label: nationality vs nation list

nations <- c("Afghanistan",
             "Albania",
             "Algeria",
             "United States",
             "Australian Aborigines",
             "Argentina",
             "Australia",
             "Austria",
             "Azerbaijan",
             "Bahamas",
             "Bangladesh",
             "Belgium",
             "Benin",
             "Bolivia",
             "Bosnia",
             "Great Britain",
             "United Kingdom",
             "Bulgaria",
             "Burkina Faso",
             "Cambodia",
             "Cameroon",
             "Canada",
             "Catalonia",
             "Chile",
             "China",
             "Colombia",
             "")
```

Let's maybe try a different approach for now. The World Wars famously impacted, well, the world. Let's just check when the art pieces were made, to see if they were during one of the two world wars:
```{r}
#| label: world wars column

wars_artworks <- artworks %>% 
  mutate(wars = case_when(
    Date < 1914 ~ "pre_ww1",
    between(Date, 1914, 1918) ~ "ww1",
    between(Date, 1918, 1939) ~ "btw_wars",
    between(Date, 1939, 1945) ~ "ww2",
    Date > 1945 ~ "post_ww2",
    .default = "none"
  ))

war_range_artworks <- artworks %>% 
  mutate(wars = case_when(
    Date < 1909 ~ "pre_ww1",
    between(Date, 1909, 1914) ~ "ww1_rising",
    between(Date, 1914, 1918) ~ "ww1",
    between(Date, 1918, 1923) ~ "ww1_falling",
    between(Date, 1923, 1934) ~ "btw_wars",
    between(Date, 1934, 1939) ~ "ww2_rising",
    between(Date, 1939, 1945) ~ "ww2",
    between(Date, 1945, 1950) ~ "ww2_falling",
    Date > 1950 ~ "post_ww2",
    .default = "none"
  ))
```

Now that we have some simple sorting, let's check if war affects medium at all. I'm thinking "classification" would be a good place to start:

```{r}
#| label: war-classification eda

wars_artworks %>% 
  filter(wars == "ww1" | wars == "ww2") %>% 
  ggplot(aes(x = Classification)) + geom_bar() +
  facet_grid(vars(wars)) + scale_x_discrete(guide = guide_axis(angle = 45))

wars_artworks %>% 
  filter(wars != "none") %>% 
  # count how many pieces are in each classification/war period combo
  count(wars, Classification) %>% 
  group_by(wars) %>% 
  mutate(n_tot = sum(n), # count how many pieces are in each war period
         prop = n / n_tot * 100, # get what percent of "pieces from this period" each category makes up
         prop = format(prop, scientific = FALSE)) %>% 
  dplyr::select(wars, Classification, prop) %>%
  pivot_wider(names_from = wars, values_from = prop) %>% # move war periods to columns
  relocate(btw_wars, .after = ww1) %>% 
  relocate(post_ww2, .after = ww2) %>% 
  replace_na(list(pre_ww1 = "0", ww1 = "0", btw_wars = "0", ww2 = "0", post_ww2 = "0")) %>%
  mutate(pre_ww1 = as.double(pre_ww1),
          ww1 = as.double(ww1),
          btw_wars = as.double(btw_wars),
          ww2 = as.double(ww2),
          post_ww2 = as.double(post_ww2)) %>% 
  filter(pre_ww1 > 1 | ww1 > 1 | btw_wars > 1 | ww2 > 1 | post_ww2 > 1)


# same thing, but using the war range dataset

war_range_artworks %>% 
  filter(wars != "none") %>% 
  # count how many pieces are in each classification/war period combo
  count(wars, Classification) %>% 
  group_by(wars) %>% 
  mutate(n_tot = sum(n), # count how many pieces are in each war period
         prop = n / n_tot * 100, # get what percent of "pieces from this period" each category makes up
         prop = format(prop, scientific = FALSE)) %>% 
  dplyr::select(wars, Classification, prop) %>%
  pivot_wider(names_from = wars, values_from = prop) %>% # move war periods to columns
  relocate(ww1_rising, .after = pre_ww1) %>% 
  relocate(btw_wars, .after = ww1_falling) %>% 
  relocate(ww2_rising, .after = btw_wars) %>% 
  relocate(post_ww2, .after = ww2_falling) %>% 
  replace_na(list(pre_ww1 = "0",
                  ww1_rising = "0",
                  ww1 = "0",
                  ww1_falling = "0",
                  btw_wars = "0",
                  ww2_rising = "0",
                  ww2 = "0",
                  ww2_falling = "0",
                  post_ww2 = "0")) %>%
  mutate(pre_ww1 = as.double(pre_ww1),
          ww1_rising = as.double(ww1_rising),
          ww1 = as.double(ww1),
          ww1_falling = as.double(ww1_falling),
          btw_wars = as.double(btw_wars),
          ww2_rising = as.double(ww2_rising),
          ww2 = as.double(ww2),
          ww2_falling = as.double(ww2_falling),
          post_ww2 = as.double(post_ww2)) %>% 
  filter(pre_ww1 > 1 |
           ww1_rising > 1 |
           ww1 > 1 |
           ww1_falling > 1 |
           btw_wars > 1 |
           ww2_rising > 1 |
           ww2 > 1 |
           ww2_falling > 1 |
           post_ww2 > 1)

artworks %>% 
  ggplot(aes(x = Date)) + geom_histogram()

wars_order <- c("none", "pre_ww1", "ww1_rising", "ww1", "ww1_falling",
                "btw_wars", "ww2_rising", "ww2", "ww2_falling", "post_ww2")

# stacked bar chart of the proportions table
war_range_artworks %>% 
  filter(wars != "none") %>% 
  # count how many pieces are in each department/war period combo
  count(wars, Department) %>% 
  group_by(wars) %>% 
  mutate(n_tot = sum(n), # count how many pieces are in each war period
         prop = n / n_tot * 100) %>% # get what percent of "pieces from this period" each category makes up)
  dplyr::select(wars, Department, prop) %>% 
  filter(!is.na(Department)) %>%
  ggplot(aes(x = wars, y = prop, fill = Department)) +
  geom_col() +
  scale_x_discrete(guide = guide_axis(angle = 45), limits = wars_order)

# exclude the most prominent bars, to get a better look at the smaller proportions
war_range_artworks %>% 
  filter(wars != "none") %>% 
  # count how many pieces are in each department/war period combo
  count(wars, Department) %>% 
  group_by(wars) %>% 
  mutate(n_tot = sum(n), # count how many pieces are in each war period
         prop = n / n_tot * 100) %>% # get what percent of "pieces from this period" each category makes up)
  dplyr::select(wars, Department, prop) %>% 
  filter(!is.na(Department) &
           Department != "Architecture & Design" &
           Department != "Drawings & Prints" &
           Department != "Photography") %>%
  ggplot(aes(x = wars, y = prop, fill = Department)) +
  geom_col() +
  scale_x_discrete(guide = guide_axis(angle = 45), limits = wars_order)

top_mediums <- wars_artworks %>% 
  count(Medium) %>% 
  arrange(desc(n)) %>% 
  slice(1:100)
```

Some interesting notes:

* Lots of categories have entries from between the wars and after WW2, but not WW1 or WW2
* Over 52% of pre-WW1 entries are photographs; the highest any other category gets in a period is 34%.
* Categories that dip during war: design, film (to 0), photograph, poster
* Categories that rise during war: drawing, frank lloyd wright archive (this one has gotta be a coincidence), painting
* Digital, document, multiple, performance, publication pieces were only made between or after the wars

Notes on the ranged data:

* Over 6% of entries from just after WW2 were notebooks, comapared to .01% during WW2
* Architecture entries were much higher proportionally during WW1 than right before or after it, while they were lower during WW2
* The film proportion peaks right before WW1, but is completely absent during WW1 itself & around WW2
* Much more of the post WW2 media is made up of smaller proportions (i.e., the 3 biggest departments make up less of the overall works)

Now, let's take a look at dimensions of different pieces:
```{r}
#| label: dimension of piece vs wartime

compact_wars_order <- c("none", "pre_ww1", "ww1", "btw_wars", "ww2", "post_ww2")

art_wars_area <- wars_artworks %>% 
  mutate(area = height * width)

art_war_range_area <- war_range_artworks %>% 
  mutate(area = height * width)

wars_artworks %>% 
  filter(!is.na(height) & !is.na(width)) %>% 
  mutate(area = height * width) %>%
  ggplot(aes(x = wars, y = area)) +
  geom_boxplot(outliers = FALSE) +
  scale_x_discrete(limits = compact_wars_order)

war_range_artworks %>% 
  filter(!is.na(height) & !is.na(width)) %>% 
  mutate(area = height * width) %>%
  ggplot(aes(x = wars, y = area)) +
  geom_boxplot(outliers = FALSE) +
  scale_x_discrete(limits = wars_order)

wars_artworks %>% 
  filter(!is.na(height) & !is.na(width)) %>% 
  mutate(area = height * width) %>% 
  summarize(.by = wars,
            min = min(area),
            mean = mean(area),
            stddev = sd(area),
            max = max(area))

wars_artworks %>% 
  filter(!is.na(height) & !is.na(width) & wars != "none") %>% 
  mutate(area = height * width) %>%
  filter(area < 5000) %>% 
  ggplot(aes(x = area, color = wars, fill = wars)) + geom_density(alpha = .1)
```

Notes:

* All of the data distributions are in the normal-to-skewed-right range
* The post WW2 time period has the most variability, and also has the highest area pieces
* WW1 has less variability than the surrounding periods, but WW2 doesn't seem that different
* Both WW1 and WW2 have a peak right before 500 cm^2^; this is higher than the peak before WW1, but lower than the (third) peak between the wars

Next up, nationality!
```{r}
#| label: nationality vs war time

wars_artworks %>% 
  filter(!is.na(Nationality.x)) %>% 
  summarize(.by = Nationality.x, count = n()) %>% 
  filter(count >= 10) %>% 
  arrange(Nationality.x)

wars_artworks %>% 
  filter(!is.na(Nationality.x)) %>% 
  summarize(.by = Nationality.x, count = n()) %>% 
  filter(count >= 75) %>% 
  ggplot(aes(x = Nationality.x, y = count)) + geom_col() + scale_x_discrete(guide = guide_axis(angle = 45))

wars_artworks %>% 
  filter(!is.na(Nationality.x)) %>%
  dplyr::select(Nationality.x, wars) %>% 
  count(Nationality.x, wars) %>% 
  group_by(Nationality.x) %>% 
  mutate(total_count = sum(n)) %>% 
  filter(total_count >= 75 & total_count <= 10000) %>%
  ggplot(aes(x = Nationality.x, y = n, fill = wars)) + 
    geom_col() +
    scale_x_discrete(guide = guide_axis(angle = 45))

wars_artworks %>% 
  filter(!is.na(Nationality.x)) %>%
  dplyr::select(Nationality.x, wars) %>% 
  count(Nationality.x, wars) %>% 
  group_by(Nationality.x) %>% 
  mutate(total_count = sum(n)) %>% 
  rename(partial_count = n) %>% 
  arrange(desc(total_count)) %>%
  row_number()
```

# Modeling

Okay, let's do some modeling now!!! I'm starting with a decision tree, just to keep it simple
```{r}
#| label: lda

set.seed(12345)

top_nats <- artworks %>% 
  count(Nationality.x) %>% 
  arrange(desc(n)) %>% 
  filter(n >= 100)

art_factor <- art_wars_area %>%
  filter(Nationality.x %in% top_nats$Nationality.x,
         !is.na(Nationality.x),
         !is.na(Gender.x),
         !is.na(area),
         !is.na(Classification))

artwork_split <- initial_split(art_factor, prop = 0.9)

art_train <- training(artwork_split)
art_test <- testing(artwork_split)

# art_tree <- rpart(Department ~ Classification, art_train, method = "class")

# art_prune <- prune.rpart(art_tree, .01)

# rpart.plot(art_tree, box.palette = "Blues")
# rpart.plot(art_prune, box.palette = "Blues")

# art_wars_area %>% 
#   count(Department)

lda_train <- art_train %>% 
  filter(Medium %in% top_mediums$Medium,
         !is.na(Medium))
lda_test <- art_test %>% 
  filter(Medium %in% top_mediums$Medium,
         !is.na(Medium))

# similar to lda, but we can still keep all the values
knn_train <- art_train %>% 
  filter(!is.na(Medium)) %>% 
  mutate(Gender.x = case_when(
    Gender.x == "male" ~ 0,
    Gender.x == "female" ~ 1,
    .default = NA
  )) %>% 
  filter(!is.na(Gender.x))
knn_test <- art_test %>% 
  filter(!is.na(Medium)) %>% 
  mutate(Gender.x = case_when(
    Gender.x == "male" ~ 0,
    Gender.x == "female" ~ 1,
    .default = NA
  )) %>% 
  filter(!is.na(Gender.x))

lda_train %>% 
  count(Nationality.x)
  
art_train %>% 
  count(Nationality.x)

lda_fit <- lda(wars ~ Nationality.x + Gender.x + Classification + area, data = art_train)
lda_med_fit <- lda(wars ~ Nationality.x + Gender.x + Medium + area, data = lda_train)

# qda_fit <- qda(wars ~ Nationality.x + Gender.x + Classification + area, data = art_train)

# now use the fitted lda model to predict on the testing data
lda_preds <- predict(lda_fit, lda_test)
lda_med_preds <- predict(lda_med_fit, lda_test)

mean(lda_preds$class == lda_test$wars, na.rm = TRUE)
mean(lda_med_preds$class == lda_test$wars, na.rm = TRUE)

lda_train_preds <- predict(lda_fit, lda_train)

mean(lda_train_preds$class == lda_train$wars, na.rm = TRUE)

mean(lda_test$wars == "post_ww2", na.rm = TRUE)


# use lda to predict medium, using war information

lda_medium_fit <- lda(Medium ~ wars + Nationality.x + Gender.x + area, data = lda_train)

lda_medium_preds <- predict(lda_medium_fit, lda_test)

mean(lda_medium_preds$class == lda_test$Medium)

# use KNN

# this was working before but nwo it's not. oh well !

# knn_preds <- knn(train = knn_train[,39],
#                  test = knn_test[,39],
#                  cl = knn_train$wars,
#                  k = 5) # use nationality, gender, medium, and area

# mean(knn_preds == lda_test$wars)
```